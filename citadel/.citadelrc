if ps -p "$$" | grep -q bash; then
	BOOT="$(readlink -e $(dirname $(realpath $BASH_SOURCE))/..)"
elif ps -p "$$" | grep -q zsh; then
	BOOT="$(readlink -e $(dirname "$0")/..)"
fi


L0_DIR="$BOOT"
L1_DIR="$BOOT/citadel/app"
L0_DIR_DEBUG="$BOOT/target/thumbv7em-none-eabihf/debug/levels"
L0_DIR_DEBUG_BIN="$BOOT/target/thumbv7em-none-eabihf/debug/levels.bin"
L1_DIR_DEBUG="$BOOT/citadel/app/target/thumbv7em-none-eabihf/debug/main"
L1_DIR_DEBUG_BIN="$BOOT/citadel/app/target/thumbv7em-none-eabihf/debug/main.bin"

build_l0(){ 
    cd $L0_DIR
    DEFMT_LOG=trace DEFMT_RTT_BUFFER_SIZE=512 cargo build
    arm-none-eabi-objcopy -O binary $L0_DIR_DEBUG $L0_DIR_DEBUG_BIN
}

build_l1(){ 
    cd $L1_DIR
    DEFMT_LOG=trace DEFMT_RTT_BUFFER_SIZE=1024 cargo build
    arm-none-eabi-objcopy -O binary $L1_DIR_DEBUG $L1_DIR_DEBUG_BIN
}

flash_impl(){ 
    st-flash write $1 $2
}

flash_l0(){ 
    flash_impl $L0_DIR_DEBUG_BIN 0x08000000
}

flash_l1(){ 
    flash_impl $L1_DIR_DEBUG_BIN 0x08004000
}

build_and_flash(){ 
    build_l0
    build_l1
    flash_l0
    flash_l1
    cd $L0_DIR
}